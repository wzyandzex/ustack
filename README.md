# ustack - 用户态 TCP/IP 协议栈

一个用 Go 语言实现的简化版用户态 TCP/IP 协议栈，包含 IP 层、ICMP、UDP、TCP 等功能，并提供了基于它的简单 HTTP 客户端/服务端。

## 项目结构

```
ustack/
├── cmd/             # 可执行程序入口
│   ├── client/      # HTTP 客户端
│   └── server/      # HTTP 服务端
├── pkg/
│   ├── eth/         # 以太网帧处理
│   ├── ip/          # IP 层处理
│   ├── icmp/        # ICMP 协议
│   ├── udp/         # UDP 协议
│   └── tcp/         # TCP 协议
├── internal/
│   └── utils/       # 公共工具（校验和、日志等）
├── test/            # 测试用例
└── README.md
```

## 功能特性

### 以太网层 (pkg/eth)
- 以太网帧封装与解析
- 支持广播和多播检测
- 完整的帧头结构体定义

### IP 层 (pkg/ip)
- IPv4 头部封装与解析
- 校验和计算
- 支持分片标志（简化实现）
- TTL 处理

### ICMP 模块 (pkg/icmp)
- Echo Request/Reply 实现
- 支持 ping 功能
- 完整的 ICMP 头部处理

### UDP 模块 (pkg/udp)
- UDP 数据包封装与解析
- 端口和长度处理
- 校验和计算

### TCP 模块 (pkg/tcp)
- 三次握手和四次挥手
- 滑动窗口实现
- 拥塞控制（慢启动、拥塞避免）
- 可靠重传机制
- 连接状态管理

### HTTP 客户端/服务端
- 基于用户态 TCP 的 HTTP 实现
- 支持 GET 请求处理
- 简单的 HTML 响应

## 设计思路

### 网络分层架构
项目严格按照 OSI 七层模型和 TCP/IP 四层模型设计：

1. **物理层/数据链路层**：以太网帧处理
2. **网络层**：IP 协议实现
3. **传输层**：TCP/UDP 协议
4. **应用层**：HTTP 客户端/服务端

### 报文封装与解析
每个协议层都实现了标准的 Marshal/Unmarshal 方法：
- 字节序处理（网络字节序）
- 校验和计算
- 长度字段处理
- 标志位管理

### 流量控制与拥塞控制
TCP 模块实现了完整的流量控制机制：
- **滑动窗口**：控制发送和接收缓冲区
- **慢启动**：连接建立时从小窗口开始
- **拥塞避免**：窗口增长到阈值后线性增长
- **快速重传**：检测到丢包时立即重传

### 并发编程
- 使用 Go 的 goroutine 处理并发连接
- 互斥锁保护共享状态
- 回调函数处理异步事件

### 数据结构
- **环形缓冲区**：用于数据包缓存
- **滑动窗口**：TCP 流量控制
- **连接表**：管理活跃连接

## 使用方法

### 编译项目
```bash
# 编译客户端
go build -o bin/ustack-client ./cmd/client

# 编译服务端
go build -o bin/ustack-server ./cmd/server
```

### 运行服务端
```bash
./bin/ustack-server 8080
```

### 运行客户端
```bash
./bin/ustack-client localhost 8080
```

## 测试

### 运行单元测试
```bash
go test ./...
```

### 运行特定测试
```bash
go test ./test -v
```

## 协议实现细节

### 以太网帧结构
```
+--------+--------+--------+--------+--------+--------+
| 目标MAC (6字节) | 源MAC (6字节) | 类型 (2字节) |
+--------+--------+--------+--------+--------+--------+
|                    数据载荷                           |
+-----------------------------------------------------+
```

### IP 头部结构
```
+--------+--------+--------+--------+
| 版本 | IHL | TOS |    总长度      |
+--------+--------+--------+--------+
|      标识      | 标志 |  片偏移    |
+--------+--------+--------+--------+
| TTL | 协议 |      校验和          |
+--------+--------+--------+--------+
|          源IP地址                  |
+--------+--------+--------+--------+
|          目标IP地址                |
+--------+--------+--------+--------+
```

### TCP 头部结构
```
+--------+--------+--------+--------+
|      源端口      |     目标端口     |
+--------+--------+--------+--------+
|              序列号                 |
+--------+--------+--------+--------+
|              确认号                 |
+--------+--------+--------+--------+
| 偏移 | 保留 | 标志 |    窗口大小    |
+--------+--------+--------+--------+
|      校验和      |   紧急指针      |
+--------+--------+--------+--------+
```

## 性能考虑

### 内存管理
- 使用对象池减少 GC 压力
- 预分配缓冲区避免频繁分配
- 零拷贝技术减少数据复制

### 并发处理
- 每个连接独立的 goroutine
- 非阻塞 I/O 操作
- 事件驱动架构

### 网络优化
- 批量发送减少系统调用
- 自适应窗口大小
- 智能重传策略

## 扩展计划

### 短期目标
- [ ] 实现完整的 IP 分片与重组
- [ ] 添加 ARP 协议支持
- [ ] 实现 TCP 选项（MSS、窗口缩放等）
- [ ] 添加 TLS/SSL 支持

### 长期目标
- [ ] IPv6 支持
- [ ] 多播和广播支持
- [ ] 网络地址转换 (NAT)
- [ ] 防火墙功能
- [ ] 性能基准测试

## 贡献指南

1. Fork 项目
2. 创建功能分支
3. 提交更改
4. 推送到分支
5. 创建 Pull Request

## 许可证

MIT License

## 联系方式

如有问题或建议，请提交 Issue 或 Pull Request。